<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Snake Bot | Next-Gen AI Demo</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #00cec9;
            --accent: #e17055;
            --bg: #1e272e;
            --panel: #2d3436;
            --text: #dfe6e9;
            --glow: 0 0 10px rgba(0, 206, 201, 0.7);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            background-image: radial-gradient(circle at 50% 50%, #2d3436 0%, #1e272e 100%);
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--primary);
            text-shadow: 0 0 20px rgba(0, 206, 201, 0.8);
            font-size: 2.5rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .container {
            display: flex;
            gap: 40px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .game-column {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            padding: 4px;
            background: linear-gradient(45deg, var(--primary), #0984e3);
        }

        canvas {
            background-color: #000;
            display: block;
            border-radius: 4px;
        }

        #stats {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            font-size: 1rem;
            width: 100%;
            justify-content: space-between;
        }

        .stat-box {
            background: rgba(45, 52, 54, 0.8);
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #636e72;
            flex: 1;
            text-align: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .highlight {
            color: var(--primary);
            font-weight: bold;
            display: block;
            font-size: 1.2rem;
            margin-top: 5px;
        }

        select {
            background: var(--panel);
            color: white;
            padding: 10px;
            border: 1px solid var(--primary);
            border-radius: 4px;
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
            width: 100%;
            margin-top: 5px;
        }

        label {
            font-weight: bold;
            color: var(--primary);
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        button {
            margin: 5px;
            padding: 12px 25px;
            font-size: 1rem;
            background: linear-gradient(180deg, #0984e3, #00cec9);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(9, 132, 227, 0.4);
            font-weight: bold;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 206, 201, 0.6);
            filter: brightness(1.2);
        }

        #dashboard {
            width: 300px;
            background: rgba(45, 52, 54, 0.9);
            padding: 25px;
            border-radius: 12px;
            height: fit-content;
            border: 1px solid #636e72;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 10px;
            border-bottom: 1px solid #444;
            transition: background 0.2s;
        }

        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .auth-card {
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            border-left: 4px solid var(--accent);
            text-align: center;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="game-column">
            <h1>AI Snake Bot</h1>

            <div id="game-container">
                <canvas id="gameCanvas" width="400" height="400"></canvas>
            </div>

            <div id="stats">
                <div class="stat-box">Score <span id="score" class="highlight">0</span></div>
                <div class="stat-box">Steps <span id="steps" class="highlight">0</span></div>
                <div class="stat-box">Status <span id="status" class="highlight"
                        style="font-size: 0.9rem; margin-top: 8px;">Ready</span></div>
            </div>

            <div style="margin-top: 30px; width: 100%;">
                <label>Select Intelligence Model:</label>
                <select id="agent-select">
                    <option value="astar">A* Search (Pathfinding)</option>
                    <option value="qlearning">Q-Learning (AI Brain)</option>
                    <option value="manual">Manual Control (Human)</option>
                </select>
            </div>

            <div id="ml-stats"
                style="margin-top:20px; display:none; background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; border: 1px solid #00cec9; width: 100%; box-sizing: border-box;">
                <h3 style="margin-top: 0; color: var(--primary); font-family: 'Orbitron'; font-size: 1rem;">Neural
                    Weights</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                    <div>Bias: <span id="w0" style="color: #ffeaa7;">0.0</span></div>
                    <div>Food Dist: <span id="w1" style="color: #ff7675;">0.0</span></div>
                    <div>Safe Space: <span id="w2" style="color: #74b9ff;">0.0</span></div>
                    <div>Danger: <span id="w3" style="color: #fab1a0;">0.0</span></div>
                </div>
            </div>

            <div style="margin-top: 25px; display: flex; gap: 10px; width: 100%; justify-content: center;">
                {% if user.is_authenticated %}
                <button onclick="startGame()">New Game</button>
                <button onclick="pauseGame()" style="background: #e67e22;">Pause</button>
                <button onclick="resumeGame()" style="background: #27ae60;">Resume</button>
                {% else %}
                <div class="auth-card" style="width: 100%;">
                    <h3 style="color: var(--accent); margin: 0 0 10px 0; font-family: 'Orbitron';">Access Restricted
                    </h3>
                    <p style="margin: 0 0 15px 0; font-size: 0.9rem; color: #b2bec3;">Login required to activate neural
                        interface.</p>
                    <a href="{% url 'login' %}">
                        <button style="width: 100%; background: var(--primary);">Login to Play</button>
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <div id="dashboard">
            <div style="text-align: right; margin-bottom: 25px;">
                {% if user.is_authenticated %}
                <div style="margin-bottom: 5px; font-size: 0.9rem; color: #b2bec3;">OPERATOR</div>
                <div style="font-family: 'Orbitron'; color: var(--primary); font-size: 1.2rem; margin-bottom: 10px;">{{ user.username }}</div>
                <a href="{% url 'logout' %}"
                    style="color: var(--accent); text-decoration: none; font-size: 0.8rem; border: 1px solid var(--accent); padding: 4px 10px; border-radius: 4px; transition: all 0.2s;">TERMINATE
                    SESSION</a>
                {% else %}
                <div style="margin-bottom: 5px;">GUEST USER</div>
                <a href="{% url 'login' %}" style="color: var(--primary); text-decoration: none;">Identify Yourself</a>
                {% endif %}
            </div>

            <h3
                style="color: #ffeaa7; border-bottom: 1px solid #636e72; padding-bottom: 10px; margin-top: 0; font-family: 'Orbitron'; font-size: 1rem;">
                PERSONAL BEST
                <span style="color: white; display: block; font-size: 2rem; margin-top: 10px;">{{ user_high_score }}</span>
            </h3>

            <h3
                style="color: #74b9ff; border-bottom: 1px solid #636e72; padding-bottom: 10px; font-family: 'Orbitron'; font-size: 1rem; margin-top: 30px;">
                GLOBAL RANKING</h3>
            <ul style="list-style: none; padding: 0; margin: 0;">
                {% for s in top_scores %}
                <li class="leaderboard-item">
                    <span style="color: #b2bec3; font-family: 'Roboto Mono';">#{{ forloop.counter }} {{ s.user.username }}</span>
                    <span style="color: #fab1a0; font-weight: bold; font-family: 'Orbitron';">{{ s.score }}</span>
                </li>
                {% empty %}
                <li style="color: #636e72; padding: 15px 0; text-align: center;">No Data Available</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const cellSize = 20; // 400px / 20 = 20x20 grid

        let gameActive = false;
        let stepCount = 0;
        let nextAction = 1; // Default Right.
        let isPaused = false;
        let currentScore = 0;

        // Sounds
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playTone(freq, type, duration) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playEatSound() { playTone(600, 'sine', 0.1); setTimeout(() => playTone(800, 'sine', 0.1), 50); }
        function playMoveSound() { playTone(200, 'triangle', 0.05); }
        function playDieSound() { playTone(150, 'sawtooth', 0.3); setTimeout(() => playTone(100, 'sawtooth', 0.4), 100); }
        function playWinSound() { playTone(400, 'square', 0.1); setTimeout(() => playTone(600, 'square', 0.1), 100); setTimeout(() => playTone(800, 'square', 0.4), 200); }

        // Key Listener
        document.addEventListener('keydown', (e) => {
            // 0=UP, 1=RIGHT, 2=DOWN, 3=LEFT
            let oldAction = nextAction;
            if (e.key === 'ArrowUp') nextAction = 0;
            else if (e.key === 'ArrowRight') nextAction = 1;
            else if (e.key === 'ArrowDown') nextAction = 2;
            else if (e.key === 'ArrowLeft') nextAction = 3;

            // If manual mode, play sound on valid key press
            if (document.getElementById('agent-select').value === 'manual' && oldAction !== nextAction) {
                // playMoveSound(); // Optional: can be annoying if spamming
            }
        });

        async function startGame() {
            const mode = document.getElementById('agent-select').value;

            // Show/Hide ML stats
            if (mode === 'qlearning') {
                document.getElementById('ml-stats').style.display = 'block';
            } else {
                document.getElementById('ml-stats').style.display = 'none';
            }

            // Reset default action for manual
            nextAction = 1;
            isPaused = false;

            try {
                const response = await fetch('/start-game/?mode=' + mode);
                const state = await response.json();
                playWinSound(); // Start sound
                render(state);
                gameActive = true;
                stepCount = 0;
                currentScore = 0;
                document.getElementById('status').innerText = "SYSTEM ACTIVE";
                document.getElementById('status').style.color = '#00cec9'; // Primary
                gameLoop();
            } catch (error) {
                console.error("Failed to start game:", error);
                document.getElementById('status').innerText = "ERROR";
                document.getElementById('status').style.color = 'red';
            }
        }

        function pauseGame() {
            if (gameActive) {
                gameActive = false;
                isPaused = true;
                document.getElementById('status').innerText = "SUSPENDED";
                document.getElementById('status').style.color = '#e67e22'; // Orange
            }
        }

        function resumeGame() {
            if (!gameActive && isPaused) {
                gameActive = true;
                isPaused = false;
                document.getElementById('status').innerText = "SYSTEM ACTIVE";
                document.getElementById('status').style.color = '#00cec9';
                gameLoop();
            }
        }

        const IS_AUTHENTICATED = {{ user.is_authenticated|yesno:"true,false" }};

        async function saveScore(score) {
            if (IS_AUTHENTICATED) {
                try {
                    await fetch('/save-score/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ score: score })
                    });
                    console.log("Score saved!");
                } catch (e) {
                    console.error("Error saving score", e);
                }
            } else {
                console.log("Not logged in, score not saved.");
            }
        }

        let previousScore = 0;

        async function gameLoop() {
            if (!gameActive) return;

            try {
                const mode = document.getElementById('agent-select').value;
                let url = '/step/';

                // If Manual, send action
                if (mode === 'manual') {
                    url += '?action=' + nextAction;
                }

                const response = await fetch(url);
                const data = await response.json();

                // Sound Logic
                if (data.score > previousScore) {
                    playEatSound();
                }
                previousScore = data.score;

                render(data);
                stepCount++;
                document.getElementById('steps').innerText = stepCount;
                currentScore = data.score;

                // Update ML weights if present
                if (data.weights) {
                    document.getElementById('w0').innerText = data.weights[0].toFixed(4);
                    document.getElementById('w1').innerText = data.weights[1].toFixed(4);
                    document.getElementById('w2').innerText = data.weights[2].toFixed(4);
                    document.getElementById('w3').innerText = data.weights[3].toFixed(4);
                }

                if (data.game_over) {
                    gameActive = false;
                    playDieSound();
                    document.getElementById('status').innerText = "TERMINATED";
                    document.getElementById('status').style.color = '#ff7675'; // Red-ish
                    saveScore(currentScore);
                    return;
                }

                // Delay
                let delay = 100;
                if (mode === 'qlearning') delay = 25;
                if (mode === 'manual') delay = 150; // Slower for human reaction time

                setTimeout(gameLoop, delay);

            } catch (error) {
                console.error("Game loop error:", error);
                gameActive = false;
            }
        }

        function render(state) {
            // Clear - slight transparency for trails? No, canvas simple clear
            ctx.fillStyle = '#1e272e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Grid lines (optional for pro look)
            ctx.strokeStyle = '#2d3436';
            ctx.lineWidth = 0.5;
            for (let i = 0; i < canvas.width; i += cellSize) {
                ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, canvas.height); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(canvas.width, i); ctx.stroke();
            }

            // Draw Snake
            state.snake.forEach((segment, index) => {
                const x = segment[0] * cellSize;
                const y = segment[1] * cellSize;

                // Head is slightly different color & glowing
                if (index === 0) {
                    ctx.fillStyle = '#81ecec';
                    ctx.shadowColor = '#00cec9';
                    ctx.shadowBlur = 10;
                } else {
                    ctx.fillStyle = '#00cec9';
                    ctx.shadowBlur = 0;
                }

                ctx.fillRect(x + 1, y + 1, cellSize - 2, cellSize - 2);
            });
            ctx.shadowBlur = 0; // Reset

            // Draw Food
            const fx = state.food[0] * cellSize;
            const fy = state.food[1] * cellSize;
            ctx.fillStyle = '#e17055'; // Food Color
            ctx.shadowColor = '#d63031';
            ctx.shadowBlur = 15;
            ctx.beginPath();
            ctx.arc(fx + cellSize / 2, fy + cellSize / 2, cellSize / 2 - 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            // Update Score
            document.getElementById('score').innerText = state.score;
        }

        // Reset previous score on new game
        function restartGame() {
            previousScore = 0;
            startGame();
        }

        // Start on load (if using keyboard, usually user initiates, but auto-start is fine if login present)
        // Removed auto-start to allow user to choose mode first or ready up.

    </script>
</body>

</html>